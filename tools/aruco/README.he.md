# זרימת עבודה עם לוח ChAruco לזיהוי תזוזת מצלמה

ספרייה זו מכילה כלים ליצירת לוחות ChAruco ושימוש בהם לזיהוי שינויי תנוחת מצלמה בזמן אמת או מזרמי וידאו.

## תוכן עניינים

- [סקירה כללית](#סקירה-כללית)
- [חלק 1: יצירה והדפסה של הלוח](#חלק-1-יצירה-והדפסה-של-הלוח)
- [חלק 2: כיול מצלמה](#חלק-2-כיול-מצלמה)
- [חלק 3: צילום תמונות עם זיהוי תנוחה](#חלק-3-צילום-תמונות-עם-זיהוי-תנוחה)
- [חלק 4: הבנת הפלט](#חלק-4-הבנת-הפלט)
- [שימוש מתקדם](#שימוש-מתקדם)
- [פתרון בעיות](#פתרון-בעיות)

---

## סקירה כללית

**לוחות ChAruco** (לוח שחמט + סמני ArUco) משלבים את הדיוק של פינות לוח שחמט עם העמידות של זיהוי סמני ArUco. הם אידיאליים עבור:

- כיול מצלמה
- הערכת תנוחה בזמן אמת
- זיהוי תזוזות/תנועות מצלמה
- יצירת מערכי נתוני אמת (ground truth)

### סיכום זרימת העבודה

```
1. יצירת לוח ← 2. הדפסת לוח ← 3. כיול מצלמה ← 4. צילום עם זיהוי תנוחה
   (board_printer.py)   (הדפסה פיזית)    (camshift_annotator.py)   (camshift_annotator.py)
```

---

## חלק 1: יצירה והדפסה של הלוח

### שלב 1.1: יצירת תמונת הלוח

השתמש ב-`board_printer.py` כדי ליצור תמונת PNG של לוח ChAruco מדויקת פיזית:

```bash
python board_printer.py
```

**פלט ברירת מחדל**: יוצר שני לוחות:
- `charuco_7x5_35mm_26mm_300dpi.png` - לוח ChAruco בגודל 7x5 (מומלץ ל-A4)
- `grid_6x8_30mm_sep6mm_300dpi.png` - לוח רשת ArUco בגודל 6x8

### שלב 1.2: התאמה אישית של פרמטרי הלוח

ערוך את `board_printer.py` או צור סקריפט מותאם אישית:

```python
from board_printer import save_charuco_png_scaled

save_charuco_png_scaled(
    path="my_board.png",
    squares_x=7,           # מספר ריבועים אופקית
    squares_y=5,           # מספר ריבועים אנכית
    square_len_m=0.035,    # ריבועים בגודל 35 מ"מ (גודל פיזי)
    marker_len_m=0.026,    # סמנים בגודל 26 מ"מ (גודל פיזי)
    dict_name="DICT_4X4_50",  # מילון ArUco
    dpi=300.0,             # רזולוציית הדפסה
    margin_mm=10.0         # שוליים לבנים מסביב ללוח
)
```

**פרמטרים עיקריים**:
- `squares_x`, `squares_y`: מידות הלוח (יותר ריבועים = מעקב טוב יותר אך קשה יותר להתאים)
- `square_len_m`: גודל פיזי של כל ריבוע בהדפסה (במטרים)
- `marker_len_m`: גודל פיזי של סמני ArUco (חייב להיות קטן מ-`square_len_m`)
- `dpi`: רזולוציה להדפסה (300 הוא סטנדרט להדפסות איכותיות)
- `dict_name`: מילון ArUco - `DICT_4X4_50` נותן 50 סמנים ייחודיים

**המלצות לגודל לוח**:
- **נייר A4** (210x297 מ"מ): 7x5 ריבועים עם ריבועים של 35 מ"מ מתאים באופן מושלם
- **נייר A3** (297x420 מ"מ): 10x7 ריבועים עם ריבועים של 40 מ"מ
- **נייר Letter** (216x279 מ"מ): דומה ל-A4

### שלב 1.3: הדפסת הלוח

**דרישות קריטיות**:
1. **הדפסה בקנה מידה של 100%** - ללא שינוי גודל/התאמה לדף
2. **הדפסה ב-DPI המדויק** - חייב להתאים ל-DPI ששימש ליצירה (300 DPI)
3. **שימוש בנייר איכותי** - נייר צילום מט עובד הכי טוב
4. **הבטחת משטח שטוח** - הלוח חייב להיות קשיח ושטוח

**שלבי הדפסה**:
1. פתח את קובץ ה-PNG במציג תמונות או ממיר PDF
2. הגדר את קנה המידה של ההדפסה ל-**100%** או **גודל ממשי**
3. ודא שהגדרת ה-DPI תואמת (300 DPI)
4. הדפס על נייר איכותי (מומלץ נייר צילום מט)
5. **ודא מידות פיזיות** באמצעות ריבוע הבדיקה של 50 מ"מ המודפס על הלוח

**אימות**:
- מדוד את **ריבוע הבדיקה של 50 מ"מ** על הלוח המודפס עם סרגל
- אם הוא לא בדיוק 50 מ"מ, קנה המדה/DPI שלך שגוי - הדפס מחדש!
- כיול נכון תלוי במידות פיזיות מדויקות

### שלב 1.4: הרכבת הלוח

**אפשרויות הרכבה**:
- **גב קשיח**: הדבק ללוח קצף, אקריליק או קרטון
- **מסגרת**: הרכב במסגרת תמונה ללא הזכוכית
- **קיר שטוח**: הצמד למשטח קיר שטוח לחלוטין

**חשוב**: הלוח חייב להיות שטוח לחלוטין. כל עיוות ישפיע על דיוק הערכת התנוחה.

---

## חלק 2: כיול מצלמה

לפני זיהוי תזוזות מצלמה, עליך לכייל את המצלמה שלך כדי לפצות על עיוותי עדשה.

### שלב 2.1: כיול אוטומטי עם ChAruco

אם אין לך קובץ כיול, `camshift_annotator.py` יכייל אוטומטית באמצעות לוח ChAruco:

```bash
python camshift_annotator.py \
    --source 0 \
    --mode charuco \
    --calib camera.yaml \
    --charuco-squares-x 7 \
    --charuco-squares-y 5 \
    --square-m 0.035 \
    --marker-m 0.026
```

**תהליך הכיול**:
1. הכלי פותח חלון מצלמה חיה
2. הזז את הלוח למיקומים וזוויות שונות
3. לחץ על **'c'** כאשר אתה רואה זיהוי טוב (פינות ירוקות מוצגות)
4. אסוף 25+ תצוגות מזוויות ומרחקים שונים
5. לחץ על **'q'** בסיום האיסוף

**טיפים לכיול טוב**:
- כסה את כל אזורי פריים המצלמה
- כלול תצוגות מוטות (לא רק ישרות)
- שנה את המרחק מהמצלמה
- ודא תאורה טובה ופוקוס חד
- שאף ל-25-30 תצוגות באיכות גבוהה

**פלט**: יוצר `camera.yaml` עם:
- מטריצת מצלמה (פרמטרים פנימיים)
- מקדמי עיוות
- מידות תמונה

### שלב 2.2: שימוש חוזר בכיול

לאחר הכיול, ניתן לעשות שימוש חוזר בקובץ `camera.yaml` עבור אותה מצלמה באותה רזולוציה:

```bash
# ריצות עוקבות טוענות אוטומטית את camera.yaml הקיים
python camshift_annotator.py --source 0 --mode charuco
```

**הערה**: כייל מחדש אם אתה:
- משנה את רזולוציית המצלמה
- משנה עדשה או הגדרות עדשה
- משתמש במצלמה אחרת
- מבחין בדיוק הערכת תנוחה ירוד

---

## חלק 3: צילום תמונות עם זיהוי תנוחה

### שלב 3.1: צילום בסיסי

צלם פריימים של מצלמה עם הערכת תנוחה בזמן אמת:

```bash
python camshift_annotator.py \
    --source 0 \
    --mode charuco \
    --out run_out \
    --draw \
    --save-frames
```

**מה קורה**:
1. המצלמה נפתחת ומתחילה לצלם
2. לוח ChAruco מזוהה בכל פריים
3. תנוחת 6-DOF (מיקום + כיוון) מוערכת
4. מחושבים הפרשי תנוחה:
   - **מול הבסיס**: שינוי מהתנוחה הראשונה שזוהתה (קו בסיס)
   - **מול הקודם**: שינוי מהפריים הקודם
5. התוצאות נשמרות ל-CSV + פריימים עם הערות

### שלב 3.2: אפשרויות שורת הפקודה

**אפשרויות מקור**:
```bash
--source 0              # מצלמת רשת ברירת מחדל (0, 1, 2, ...)
--source video.mp4      # קובץ וידאו
--source rtsp://...     # זרם מצלמת רשת
```

**תצורת לוח** (חייבת להתאים ללוח המודפס):
```bash
--charuco-squares-x 7   # ריבועים אופקיים
--charuco-squares-y 5   # ריבועים אנכיים
--square-m 0.035        # גודל ריבוע במטרים (35 מ"מ = 0.035 מ')
--marker-m 0.026        # גודל סמן במטרים (26 מ"מ = 0.026 מ')
--dict DICT_4X4_50      # שם מילון ArUco
```

**בקרת צילום**:
```bash
--max-rate 20.0         # פריימים מקסימליים לשנייה (ברירת מחדל: 20 הרץ)
--save-frames           # שמור תמונות פריים עם הערות
--frame-ext jpg         # פורמט תמונת פריים (jpg או png)
--draw                  # הצג חלון הדמיה חיה
```

**בקרת פלט**:
```bash
--out run_out           # ספריית פלט
--calib camera.yaml     # קובץ כיול מצלמה
--board-png             # יצא תמונת לוח לספריית הפלט
```

### שלב 3.3: הדמיה בזמן אמת

בעת שימוש ב-`--draw`, החלון החי מציג:
- לוח ChAruco שזוהה עם פינות מודגשות
- צירי קואורדינטות תלת-ממדיים בראשית הלוח
- זווית הסבסוב הנוכחית (סיבוב סביב ציר Z)

**פקדים**:
- **ESC** או **'q'**: עצור צילום וצא
- החלון מתעדכן אוטומטית בקצב הצילום

### שלב 3.4: דוגמאות להפעלות

**בדיקה מהירה עם תצוגה חיה**:
```bash
python camshift_annotator.py --source 0 --draw
```

**צילום ייצור** (ללא תצוגה, שמירת כל הפריימים):
```bash
python camshift_annotator.py \
    --source 0 \
    --out dataset_001 \
    --save-frames \
    --max-rate 10.0
```

**עיבוד קובץ וידאו**:
```bash
python camshift_annotator.py \
    --source input_video.mp4 \
    --out video_analysis \
    --save-frames \
    --draw
```

---

## חלק 4: הבנת הפלט

### מבנה ספריית הפלט

```
run_out/
├── poses.csv              # נתוני תנוחה פריים-אחר-פריים
├── frames/                # תמונות פריים עם הערות (אם --save-frames)
│   ├── frame_000000.jpg
│   ├── frame_000001.jpg
│   └── ...
└── charuco_board.png      # ייחוס לוח (אם --board-png)
```

### פורמט CSV: `poses.csv`

כל שורה מייצגת פריים מצולם אחד עם מידע תנוחה מלא:

| עמודה | תיאור | יחידות |
|---|---|---|
| `frame_idx` | מספר פריים רציף | - |
| `timestamp_ns` | חותמת זמן צילום | ננו-שניות |
| `detected` | האם הלוח זוהה? | 0/1 |
| `curr_tx_m`, `curr_ty_m`, `curr_tz_m` | מיקום מצלמה נוכחי | מטרים |
| `curr_roll_deg`, `curr_pitch_deg`, `curr_yaw_deg` | כיוון מצלמה נוכחי | מעלות |
| `base_tx_m`, `base_ty_m`, `base_tz_m` | שינוי מיקום מקו הבסיס | מטרים |
| `base_roll_deg`, `base_pitch_deg`, `base_yaw_deg` | שינוי כיוון מקו הבסיס | מעלות |
| `prev_tx_m`, `prev_ty_m`, `prev_tz_m` | שינוי מיקום מהפריים הקודם | מטרים |
| `prev_roll_deg`, `prev_pitch_deg`, `prev_yaw_deg` | שינוי כיוון מהפריים הקודם | מעלות |
| `inliers_count` | מספר פינות ChAruco שזוהו | - |

**מערכת קואורדינטות** (פריים הלוח):
- **X**: ימינה (לאורך האופקי של הלוח)
- **Y**: מטה (לאורך האנכי של הלוח)
- **Z**: הרחק מהלוח (לתוך הסצנה)
- **ראשית**: הפינה השמאלית העליונה של הלוח

**מוסכמת סיבוב** (זוויות אוילר ZYX):
- **גלגול** (ציר X): סיבוב סביב X
- **עלרוד** (ציר Y): סיבוב סביב Y
- **סבסוב** (ציר Z): סיבוב סביב Z

### הבנת הפרשי תנוחה

**הפרש בסיס** (עמודות `base_*`):
- מודד שינוי מה**זיהוי המוצלח הראשון**
- שימושי למעקב אחר סחיפה כוללת לאורך זמן
- דוגמה: "המצלמה זזה 5 ס"מ ימינה וסובבה 2 מעלות מאז ההתחלה"

**הפרש קודם** (עמודות `prev_*`):
- מודד שינוי מה**פריים הקודם**
- שימושי לזיהוי תנועות מיידיות
- דוגמה: "המצלמה זזה 2 מ"מ בין פריימים"

### דוגמת ניתוח

**זיהוי אירועי תזוזת מצלמה**:
```python
import pandas as pd

df = pd.read_csv("run_out/poses.csv")

# חשב את גודל התרגום מקו הבסיס
df['base_shift_m'] = (
    df['base_tx_m']**2 +
    df['base_ty_m']**2 +
    df['base_tz_m']**2)**0.5

# מצא פריימים עם תזוזה > 1 ס"מ מקו הבסיס
shifts = df[df['base_shift_m'] > 0.01]
print(f"נמצאו {len(shifts)} פריימים עם תזוזה > 1 ס"מ")

# זהה תנועות פתאומיות (> 5 מ"מ בין פריימים)
df['frame_motion_m'] = (
    df['prev_tx_m']**2 +
    df['prev_ty_m']**2 +
    df['prev_tz_m']**2)**0.5
sudden = df[df['frame_motion_m'] > 0.005]
print(f"נמצאו {len(sudden)} תנועות פתאומיות")
```

---

## שימוש מתקדם

### שימוש ב-GridBoard במקום ChAruco

GridBoards משתמשים רק בסמני ArUco (ללא תבנית לוח שחמט):

```bash
python camshift_annotator.py \
    --mode gridboard \
    --grid-markers-x 5 \
    --grid-markers-y 7 \
    --marker-m 0.030 \
    --grid-sep-m 0.006 \
    --calib camera.yaml
```

**GridBoard מול ChAruco**:
- **ChAruco**: מדויק יותר, טוב יותר לכיול, דורש כיול מצלמה
- **GridBoard**: פשוט יותר, עמיד יותר בזוויות, דורש כיול קיים

### יצירת לוחות מותאמים אישית באופן פרוגרמטי

```python
from board_printer import save_charuco_png_scaled, save_gridboard_png_scaled

# לוח גדול לצילום מרחוק
save_charuco_png_scaled(
    path="large_board.png",
    squares_x=10,
    squares_y=7,
    square_len_m=0.050,      # ריבועים של 50 מ"מ
    marker_len_m=0.037,      # סמנים של 37 מ"מ
    dpi=300.0
)

# לוח בצפיפות גבוהה לטווח קרוב
save_charuco_png_scaled(
    path="dense_board.png",
    squares_x=12,
    squares_y=9,
    square_len_m=0.020,      # ריבועים של 20 מ"מ
    marker_len_m=0.015,      # סמנים של 15 מ"מ
    dpi=600.0                # DPI גבוה יותר לריבועים קטנים
)
```

### צילום בקצב מוגבל להפעלות ארוכות

```bash
# צלם ב-5 הרץ להפחתת נפח הנתונים
python camshift_annotator.py \
    --source 0 \
    --max-rate 5.0 \
    --out long_session
```

### אינטגרציה עם כלים אחרים

**יצוא לוח לכיול**:
```bash
python camshift_annotator.py --board-png --out calibration_kit
```

**עיבוד וידאו קיים**:
```bash
python camshift_annotator.py \
    --source field_recording.mp4 \
    --calib camera.yaml \
    --out analysis \
    --save-frames
```

---

## פתרון בעיות

### הלוח לא מזוהה

**תסמינים**: `detected=0` ב-CSV, אין הדמיה

**פתרונות**:
1. **בדוק שהפרמטרים של הלוח תואמים**: ודא ש-`--square-m` ו-`--marker-m` תואמים ללוח המודפס שלך
2. **שפר תאורה**: ודא תאורה אחידה ובהירה ללא סנוור
3. **בדוק פוקוס**: המצלמה חייבת להיות בפוקוס על הלוח
4. **ודא איכות הדפסה**: בדוק שהסמנים חדים ובעלי ניגודיות גבוהה
5. **מרחק**: התקרב או התרחק כדי שהלוח יהיה במלואו בפריים
6. **אי-התאמה במילון**: ודא ש-`--dict` תואם ליצירת הלוח

### דיוק תנוחה ירוד

**תסמינים**: תנוחה רועדת, ערכים לא מציאותיים, קפיצות גדולות

**פתרונות**:
1. **כייל מחדש את המצלמה**: כיול ישן עלול להיות לא תקף
2. **ישר את הלוח**: ודא שהלוח שטוח לחלוטין, ללא עיוותים
3. **בדוק מידות פיזיות**: ודא שהריבועים המודפסים תואמים ל-`square_len_m`
4. **שפר זיהוי**: יותר פינות שזוהו = תנוחה טובה יותר (בדוק `inliers_count`)
5. **תאורה טובה יותר**: הפחת צללים וסנוור
6. **הרכבה יציבה**: ודא שהלוח לא רוטט או זז

### כיול נכשל

**תסמינים**: "לא מספיק תצוגות" או "הכיול נכשל"

**פתרונות**:
1. **אסוף עוד תצוגות**: צריך 25+ תצוגות באיכות גבוהה
2. **שנה זוויות**: כלול תצוגות מוטות ומסובבות
3. **כסה את הפריים**: כייל עם הלוח בכל אזורי התמונה
4. **בדוק זיהוי**: ודא שפינות ירוקות מופיעות לפני לחיצה על 'c'
5. **תאורה טובה**: כיול דורש תמונות ברורות וחדות

### קנה מידה פיזי שגוי

**תסמינים**: מרחקים במטרים לא תואמים למציאות

**פתרונות**:
1. **מדוד ריבוע בדיקה**: ודא שריבוע 50 מ"מ על הלוח המודפס הוא בדיוק 50 מ"מ
2. **ודא קנה מידה הדפסה**: חייב להדפיס ב-100%, ללא שינוי גודל אוטומטי
3. **בדוק DPI**: DPI ההדפסה חייב להתאים ל-DPI היצירה (300)
4. **עדכן פרמטרים**: אם מדפיסים מחדש, עדכן את `square_len_m` לגודל הנמדד בפועל

### שימוש גבוה במעבד

**תסמינים**: המחשב מאט, פריימים נופלים

**פתרונות**:
1. **הפחת את קצב הצילום**: השתמש ב-`--max-rate 10.0` או פחות
2. **השבת הדמיה**: הסר את הדגל `--draw`
3. **השבת שמירת פריימים**: הסר את `--save-frames` אם אין צורך
4. **הורד רזולוציה**: הפחת את רזולוציית המצלמה בהגדרות המצלמה

---

## הפניה מהירה

### דוגמה לזרימת עבודה מלאה

```bash
# 1. יצירת לוח (חד פעמי)
python board_printer.py

# 2. הדפס את הלוח בקנה מידה 100%, 300 DPI

# 3. ריצה ראשונה: כיול + צילום
python camshift_annotator.py \
    --source 0 \
    --mode charuco \
    --charuco-squares-x 7 \
    --charuco-squares-y 5 \
    --square-m 0.035 \
    --marker-m 0.026 \
    --out session_001 \
    --draw \
    --save-frames

# 4. ריצות עוקבות: רק צילום
python camshift_annotator.py \
    --source 0 \
    --out session_002 \
    --save-frames
```

### פרמטרי ברירת מחדל

אם הלוח שלך משתמש בברירות המחדל האלה, אינך צריך לציין אותם:

```
--mode charuco
--dict DICT_4X4_50
--charuco-squares-x 7
--charuco-squares-y 5
--square-m 0.035
--marker-m 0.026
--calib camera.yaml
--max-rate 20.0
```

---

## הפניות

- **תיעוד OpenCV ArUco**: https://docs.opencv.org/4.x/d5/dae/tutorial_aruco_detection.html
- **מדריך לוח ChAruco**: https://docs.opencv.org/4.x/df/d4a/tutorial_charuco_detection.html
- **הפניה למילון ArUco**: https://docs.opencv.org/4.x/d9/d6a/group__aruco.html

---

## תמיכה

לבעיות או שאלות:
1. בדוק את סעיף [פתרון בעיות](#פתרון-בעיות)
2. ודא שהלוח המודפס שלך תואם לפרמטרי היצירה
3. ודא שכיול המצלמה עדכני ותקף
4. עיין בפלט ה-CSV לאיכות הזיהוי (`detected`, `inliers_count`)

```